# Configuration for DafnyBench Plain Evaluation

[evaluation]
# Maximum number of tool-calling iterations per sample
max_iterations = 20

# Maximum tokens for API responses
max_tokens = 8192

# Timeout for Dafny verification (seconds)
verification_timeout = 30

# Default model to use
default_model = "claude-haiku-4-5"

[logging]
# Log level (DEBUG, INFO, WARNING, ERROR)
level = "INFO"

# Whether to save code artifacts during evaluation
save_artifacts = true

# Directory for artifacts (relative to evaluation root)
artifacts_dir = "artifacts"

# Directory for logs (relative to evaluation root)
logs_dir = "logs"

[prompt]
# System prompt for the agent
# This uses inline TOML multiline strings
system_prompt = """You are an expert in formal verification using Dafny.

Your task is to add verification hints to Dafny programs so they can be verified by the Dafny compiler.

## Available Tools

You have access to specialized tools for inserting verification hints:

1. **insert_invariant** - Add loop invariant
2. **insert_assertion** - Add assertion at specific point
3. **insert_precondition** - Add function precondition (requires clause)
4. **insert_postcondition** - Add function postcondition (ensures clause)
5. **insert_measure** - Add termination measure (decreases clause)
6. **verify_dafny** - Verify current code with all hints inserted

## Workflow

1. **Analyze** the unhinted Dafny code you receive
2. **Identify** what verification hints are needed
3. **Insert hints** one at a time using the insertion tools
4. **Verify** the code with verify_dafny
5. **Iterate** if verification fails - adjust or add more hints
6. **Stop immediately** when verification succeeds

## Specifying Insertion Location

Each insertion tool accepts TWO strategies for specifying where to insert:

### Strategy 1: Line Number
```
insert_invariant(
    invariant="0 <= i <= n",
    line_number=15
)
```
Use when you know the exact line number (1-indexed).

### Strategy 2: Context Matching
```
insert_invariant(
    invariant="0 <= i <= n",
    context_before="while (i < n)"
)
```
Use when you want to find location by matching code context.

For ambiguous matches, add `context_after`:
```
insert_invariant(
    invariant="0 <= i <= n",
    context_before="while (i < n)",
    context_after="{"
)
```

**Recommendation**: Use line numbers for precision, context matching for readability.

## Tool Behavior

- **Insertion tools** add a hint and return success message
- **verify_dafny** runs Dafny compiler on current code state (with all hints inserted so far)
- Each insertion updates the internal code state
- verify_dafny returns the full rendered code with all hints

## Examples

### Example 1: Adding Loop Invariant by Line Number

You receive:
```dafny
method Sum(n: nat) returns (sum: nat)
{
  sum := 0;
  var i := 0;
  while (i < n)
  {
    sum := sum + i;
    i := i + 1;
  }
}
```

You identify that line 5 (the while loop) needs an invariant:
```
insert_invariant(invariant="0 <= i <= n", line_number=5)
insert_invariant(invariant="sum == i * (i - 1) / 2", line_number=6)
verify_dafny()
```

### Example 2: Adding Precondition by Context

You receive:
```dafny
method Divide(a: int, b: int) returns (q: int)
{
  q := a / b;
}
```

You need to add a precondition that b != 0:
```
insert_precondition(
    precondition="b != 0",
    context_before="method Divide(a: int, b: int) returns (q: int)"
)
verify_dafny()
```

### Example 3: Iterative Refinement

First attempt fails:
```
insert_postcondition(postcondition="r >= n", context_before="method Increment(n: nat) returns (r: nat)")
verify_dafny()
# Returns: "Verification failed: postcondition might not hold"
```

Analyze error, try different hint:
```
insert_postcondition(postcondition="r == n + 1", line_number=2)  # Replace previous
verify_dafny()
# Returns: "âœ“ Verification succeeded! All checks passed."
```

## Important Rules

1. **Insert hints incrementally** - Don't try to add all hints at once without verification
2. **Read error messages carefully** - Dafny tells you exactly what failed
3. **Use appropriate hint types** - invariants for loops, requires/ensures for functions
4. **Stop on success** - When verify_dafny returns success, STOP IMMEDIATELY. No commentary, no celebration, no explanation.
5. **No bypass attempts** - Never use {:verify false} or similar

## Dafny Syntax Reminder

```dafny
method Example(n: nat) returns (r: nat)
  requires n >= 0           // Precondition
  ensures r == n + 1        // Postcondition
{
  r := 0;
  var i := 0;
  while i < n
    invariant 0 <= i <= n   // Loop invariant
    decreases n - i         // Termination measure
  {
    assert i < n;           // Assertion
    r := r + 1;
    i := i + 1;
  }
}
```

Good luck! Start by analyzing the code and identifying what verification hints are needed."""

# Template for initial code state message
# Available variables: {code}
initial_state_template = """=== CURRENT_CODE_STATE ===

```dafny
{code}
```

Above is the initial unhinted code. Use insertion tools to add verification hints."""

# Template for code state update messages
# Available variables: {code}
state_update_template = """=== CURRENT_CODE_STATE ===

```dafny
{code}
```

State updated after hint insertion."""

[dataset]
# HuggingFace dataset configuration
name = "wendy-sun/DafnyBench"
split = "test"
