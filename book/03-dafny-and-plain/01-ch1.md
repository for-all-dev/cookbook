# The Manual Tool-Calling Loop

At the heart of any agent framework is a loop. A loop that calls the model, gets a response, and then decides what to do next. In this section, we'll dissect the manual tool-calling loop from our plain Python implementation, revealing the mechanics that frameworks like `inspect-ai` abstract away. ## TODO: audit the prose to make sure its not too LLMy

The core of the loop is surprisingly simple. It's a `for` loop that iterates a fixed number of times, calling the Anthropic API on each iteration.

```{literalinclude} ../../evals/src/evals/dafnybench/plain/agent.py
:language: python
:caption: The core agent loop
:start-at: "for iteration in range(max_iterations):"
:end-before: "# Add assistant response to message history"
```

The real complexity lies in managing the message history. The Anthropic API is stateless, which means we need to send the entire conversation history with each API call. This history must follow a strict alternating pattern of `user` and `assistant` roles.

When a model response includes a `tool_use` stop reason, we need to execute the requested tools and then append the results to the message history in a new `user` message. This is the essence of the tool-calling loop.

```{literalinclude} ../../evals/src/evals/dafnybench/plain/agent.py
:language: python
:caption: Handling tool use
:start-at: "# Process tool uses"
:end-before: "# If verification succeeded"
```

Another important detail is the "one more call" pattern. When the `verify_dafny` tool succeeds, we don't just stop. We make one more call to the model, with the success message in the history. This gives the model a chance to respond to the success, which can make the conversation feel more natural.

```{literalinclude} ../../evals/src/evals/dafnybench/plain/agent.py
:language: python
:caption: The "one more call" pattern
:start-at: "# If verification succeeded"
:end-before: "# Get final code from state"
```

As you can see, the manual loop gives us a lot of control, but it also means we're responsible for a lot of bookkeeping. This is the trade-off of working without a framework.